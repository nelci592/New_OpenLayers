<?php
/**
 * node-php-awesome-server router settings
 */
if (getenv('NODE_NPAS_EXPOSED_VARS') !== FALSE && ($ev = json_decode(getenv('NODE_NPAS_EXPOSED_VARS'))) !== FALSE) {


    foreach ($ev as $k => $v) {
        $_SERVER[strtoupper($v)] = json_decode(getenv($v), true) !== NULL ? json_decode(getenv($v), true) : getenv($v);
    }

    if (isset($_SERVER['NODE_NPAS_ENVIRONMENT']) && is_array($_SERVER['NODE_NPAS_ENVIRONMENT'])) {

        foreach ($_SERVER['NODE_NPAS_ENVIRONMENT'] as $k => $v) {

            if (!in_array($k, $ev)) {
                $_SERVER[strtoupper($k)] = $v;
            }

        }

    }

    if (isset($_SERVER['NODE_NPAS_WORKER_ID']) && isset($_SERVER['HTTP_NPAS_WORKER_ID'])) {

        $_SERVER['NODE_NPAS_WORKER_ID'] = $_SERVER['HTTP_NPAS_WORKER_ID'];

    }

    /**
     * Override SERVER with NPAS_FIX
     */
    foreach ($_SERVER as $k => $v) {
        if (substr($k, 0, strlen('HTTP_NPAS_FIX_')) == 'HTTP_NPAS_FIX_') {
            $_SERVER[substr($k, strlen('HTTP_NPAS_FIX_'))] = $v;
            unset($_SERVER[$k]);
        }
    }


    /**
     * Set headers from NPAS_SET_HEADER
     */
    foreach ($_SERVER as $k => $v) {
        if (substr($k, 0, strlen('HTTP_NPAS_SET_HEADER_')) == 'HTTP_NPAS_SET_HEADER_') {
            header(str_replace('_','-',substr($k, strlen('HTTP_NPAS_SET_HEADER_'))).': '.$v);
            unset($_SERVER[$k]);
        }
    }

    $_SERVER['PHP_VERSION'] = substr(phpversion(), 0, 1);

    if (
        isset($_SERVER['NODE_NPAS_EXPRESS_SECURE_ORIGIN']) &&
        $_SERVER['NODE_NPAS_EXPRESS_SECURE_ORIGIN'] &&
        isset($_SERVER['HTTP_NPAS_EXPRESS_HOSTNAME']) &&
        isset($_SERVER['HTTP_NPAS_EXPRESS_HOSTNAME_PORT'])) {

        $boom = explode(':', $_SERVER['HTTP_HOST']);
        $boom[0] = $_SERVER['HTTP_NPAS_EXPRESS_HOSTNAME'];
        $boom[1] = $_SERVER['HTTP_NPAS_EXPRESS_HOSTNAME_PORT'];

        $_SERVER['HTTP_HOST'] = implode(":", $boom);
        $_SERVER['NODE_NPAS_EXPRESS_URL'] = $_SERVER['NODE_NPAS_EXPRESS_PROTOCOL'] . '://' . $_SERVER['HTTP_HOST'];

    }

}
